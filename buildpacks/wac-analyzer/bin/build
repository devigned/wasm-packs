#!/usr/bin/env bash


echo "{}" > .projects.json

# for each directory in the current working directory add the directory to the path to a json file named .wasm-projects using jq
for dir in */; do
    # add the directory to the json file
    isJS "$dir" && project=${dir%*/} yq -iP '.js += [strenv(project)]' .projects.json
    isGo "$dir" && project=${dir%*/} yq -iP '.go += [strenv(project)]' .projects.json
done

function isJS() {
  local project_root="$1"
  if [ ! -d $project_root ]; then
    return false
  fi

  # if package.json does not exist
  if [ ! -f "./${project_root}/package.json" ]; then
    return false
  fi

  # if the package.json does not contain the string "@bytecodealliance/componentize-js"
  if ! grep -q "@bytecodealliance/componentize-js" "./${project_root}/package.json"; then
    return false
  fi

  # if there are no files that end with .wit or no wit directory
  files=( "./${project_root}/*.wit" )
  if ! (( ${#files[@]} )) && [ ! -d "./${project_root}/wit" ] ; then
    return false
  fi
  echo "isGo: ${project_root} is a JS project"
}

function isGo() {
  local project_root="$1"
  if [ ! -d $project_root ]; then
    echo "isGo: not a directory"
    return false
  fi

  # if go.mod does not exist
  if [ ! -f "./${project_root}/go.mod" ]; then
    return false
  fi

  # if the go.world.toml does not exist.
  if [ ! -f "./${project_root}/go.world.toml" ]; then
    return false
  fi

  # if there are no files that end with .wit or no wit directory
  files=( "*.wit" )
  if ! (( ${#files[@]} )) && [ ! -d "./${project_root}/wit" ] ; then
    return false
  fi
  echo "isGo: ${project_root} is a Go project"
}
