#!/usr/bin/env bash

set -euo pipefail

if [ -f "compose.wac" ]; then
  # Setup a layer for the for components needed for composition. They are only needed at build time.
  wasm_component_layer="${CNB_LAYERS_DIR}/wasm-js-components"
  mkdir -p "${wasm_component_layer}"
  cat > "${wasm_component_layer}.toml" << EOL
[types]
launch = false
cache = false
build = true
EOL

  # Find each JS project listed in the .projects.json file and build them
  for project in $(jq -r '.js[]' .projects.json); do
    echo "Building js ${project}"
    cd "${project}"
    # build the project
    npm install
    local name="${project}.component.wasm"
    COMPONENT_NAME="${name}" npm run build
    cp "${name}" "${wasm_component_layer}"
  done
  exit 0
fi

# Wasm JS project was found, but it is not a composition project
wasm_component_layer="${CNB_LAYERS_DIR}/wasm-js-components"
mkdir -p "${wasm_component_layer}"
cat > "${wasm_component_layer}.toml" << EOL
[types]
launch = true
cache = false
build = false
EOL

echo "---> Copying .wasm files to layer"

# recursively copy all files ending in .wasm into the layer directory and ignore the target and node_module directories
find . -name "*.wasm" -not -path "./target/*" -not -path "./node_modules/*" -exec cp {} "${wasm_component_layer}" \;

# Set default start command
cat > "${CNB_LAYERS_DIR}/launch.toml" << EOL
[[processes]]
type = "web"
command = ["wasmtime", "serve", "-S", "cli", "${CNB_LAYERS_DIR}/wasm-js-components/server.component.wasm"]
default = true
EOL

exit 0
